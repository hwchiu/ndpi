.PHONY : clean

INCLUDE=-Isrc/include -Isrc/lib/third_party/include

CFLAGS= -fPIC -g $(INCLUDE)
LDFLAGS= -shared
LIBS=-lpthread

SOURCES = $(shell echo src/lib/*.c src/lib/protocols/*.c src/lib/third_party/src/*.c)
READER=example/ndpiReader

RANLIB=ranlib
CC=gcc
NDPI_LIBDIR=lib

OBJECTS=$(SOURCES:.c=.o)

NDPI_SHARED=$(NDPI_LIBDIR)/libndpi-@PACKAGE_VERSION@.so
NDPI_STATIC=$(NDPI_LIBDIR)/libndpi.a

JSON_HOME=example/third-party/json-c
JSON_INC=-I$(JSON_HOME)
JSON_LIB=$(JSON_HOME)/.libs/libjson-c.a

all: $(NDPI_SHARED) $(READER)

clean:
	rm -rf $(OBJECTS) $(NDPI_SHARED) autom4te.cache *~ config.log config.status $(NDPI_LIBDIR)/* bin/*

cleanall: clean
	rm -f config.h configure Makefile

$(NDPI_SHARED) : $(OBJECTS)
	$(CC) $(CFLAGS) $(OBJECTS) -o $@ $(LDFLAGS) -Wl,-soname
	cd $(NDPI_LIBDIR); ln -s libndpi-@PACKAGE_VERSION@.so libndpi.so

$(NDPI_STATIC): $(OBJECTS)
	ar rc $(NDPI_STATIC) $(OBJECTS)
	$(RANLIB) $@

$(READER): $(NDPI_STATIC) $(JSON_LIB)
	$(CC) $(CFLAGS) $(JSON_INC) @PCAP_INC@ example/ndpiReader.c -o $@ $(NDPI_STATIC) @PCAP_LIB@ $(JSON_LIB) $(LIBS)

$(JSON_LIB):
	cd $(JSON_HOME); ./autogen.sh; ./configure; make

#$(READER): $(NDPI_SHARED) src/example/ndpiReader.c
#	$(CC) $(CFLAGS) src/example/ndpiReader.c -o $@ $(NDPI_SHARED) $(LIBS)

install: all
	mkdir -p @INSTALL_PREFIX@/include @INSTALL_PREFIX@/lib @INSTALL_PREFIX@/bin
	cp ./include/*.h @INSTALL_PREFIX@/include
	cp ./lib/* @INSTALL_PREFIX@/lib
	cp ./bin/* @INSTALL_PREFIX@/bin
